<% 
function formatFlexTime(min) {
  min = Number(min) || 0;
  const sign = min < 0 ? '-' : '';
  min = Math.abs(min);
  if (min >= 60) {
    const h = Math.floor(min / 60);
    const m = min % 60;
    return `${sign}${h} h${m > 0 ? ' ' + m + ' min' : ''}`;
  }
  return `${sign}${min} min`;
}
%>
<!DOCTYPE html>
<html lang="<%= (user && user.preferred_language) || 'en' %>">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grumpy Tracker</title>
    <link href="/public/tailwind.css" rel="stylesheet">
  </head>
  <body class="bg-grumpy-dark min-h-screen flex flex-col font-sans text-grumpy-offwhite">
    <!-- Remove duplicate header and logo, only keep menu -->
    <%- include('partials/menu', { user, csrfToken, currentPath: request.path }) %>
    <main class="flex-1 flex flex-col p-4 sm:p-6">
      <div class="w-full max-w-5xl mx-auto flex flex-col md:flex-row gap-6 items-stretch">
        <!-- Flex Time Card vänster på desktop, överst på mobil -->
        <div class="flex flex-col max-w-xs w-full md:w-64 bg-grumpy-dark2 border border-grumpy-orange rounded-2xl shadow-xl p-4 sm:p-6 pointer-events-auto self-start md:self-start mx-auto md:mx-0 h-full">
          <div class="w-full">
            <h2 class="text-lg font-bold text-grumpy-orange mb-3">
              <%= t('dashboard.flex_time', 'Flex Time') %>
            </h2>
            <div class="flex flex-col gap-2 w-full">
              <div class="flex justify-between items-center">
                <span class="font-semibold text-grumpy-offwhite"><%= t('dashboard.flex_time_work_total', 'Total Work') %>:</span>
                <span class="text-xl font-extrabold text-grumpy-orange"><%= formatFlexTime(flexTotalWork) %></span>
              </div>
              <div class="flex justify-between items-center">
                <span class="font-semibold text-grumpy-offwhite"><%= t('dashboard.flex_time_work_travel_total', 'Total + Travel') %>:</span>
                <span class="text-xl font-extrabold text-grumpy-orange"><%= formatFlexTime(flexTotalWorkTravel) %></span>
              </div>
            </div>
          </div>
        </div>
        <!-- Flex Graph Card -->
        <div class="bg-grumpy-dark2 border border-grumpy-orange rounded-2xl shadow-lg p-4 sm:p-8 flex flex-col flex-1 min-w-0 max-w-3xl h-full">
          <h2 class="text-xl font-bold text-grumpy-orange mb-4"><%= t('dashboard.flex_graph', 'Work & Travel Time') %></h2>
          <form method="get" class="mb-4 flex flex-wrap gap-2 items-center">
            <label for="period" class="text-grumpy-offwhite font-semibold"><%= t('dashboard.period', 'Period') %>:</label>
            <select id="period" name="period" class="bg-grumpy-dark2 border border-grumpy-orange rounded p-1 text-grumpy-offwhite">
              <option value="week" <%= period === 'week' ? 'selected' : '' %>><%= t('dashboard.week', 'Week') %></option>
              <option value="month" <%= period === 'month' ? 'selected' : '' %>><%= t('dashboard.month', 'Month') %></option>
              <option value="year" <%= period === 'year' ? 'selected' : '' %>><%= t('dashboard.year', 'Year') %></option>
            </select>
            <button type="submit" class="bg-grumpy-orange text-grumpy-dark2 px-3 py-1 rounded font-semibold hover:bg-grumpy-dark2 hover:text-grumpy-orange border border-grumpy-orange transition"><%= t('dashboard.show', 'Show') %></button>
          </form>
          <div class="w-full overflow-x-auto">
            <canvas id="flexChart" class="max-w-full" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
var chartLabels = JSON.parse('<%- JSON.stringify(chartLabels) %>');
var chartWork = JSON.parse('<%- JSON.stringify(chartWork) %>');
var chartWorkTravel = JSON.parse('<%- JSON.stringify(chartWorkTravel) %>');
const ctx = document.getElementById('flexChart').getContext('2d');
const flexChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: chartLabels,
    datasets: [
      {
        label: "<%= t('dashboard.work_time', 'Work Time') %>",
        data: chartWork,
        borderColor: '#e76a2e',
        backgroundColor: 'rgba(231,106,46,0.1)',
        fill: true,
        tension: 0.3
      },
      {
        label: "<%= t('dashboard.work_travel_time', 'Work + Travel Time') %>",
        data: chartWorkTravel,
        borderColor: '#f6eadd',
        backgroundColor: 'rgba(246,234,221,0.1)',
        fill: true,
        tension: 0.3
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { labels: { color: '#f6eadd' } }
    },
    scales: {
      x: { ticks: { color: '#f6eadd' } },
      y: { ticks: { color: '#f6eadd' } }
    }
  }
});
    </script>
    <%- include('partials/footer') %>
  </body>
</html>
